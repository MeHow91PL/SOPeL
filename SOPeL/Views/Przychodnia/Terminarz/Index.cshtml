@*<script src="~/Scripts/terminarz.js"></script>*@
<div class="container kontenerMaterial">
    <div class="container">
        <div id="terminarzDataKontener" class="col-lg-4 col-md-4 col-sm-4 col-xs-10">
            <label for="wybor-daty-terminarz">Data</label>
            <input type="text" value="@DateTime.Now.Year-@string.Format("{0:00}", DateTime.Now.Month)-@string.Format("{0:00}", DateTime.Now.Day)" id="wybor-daty-terminarz" name="wybor-daty-terminarz" class="form-control datepicker" />
        </div>

        <div class="col-lg-1 col-lg-offset-7 col-md-1 col-md-offset-7 col-sm-1 col-sm-offset-7 col-xs-2">
            <a id="opcje-terminarza-button">
                <img src="~/Content/Images/opcje.svg" alt="Opcje" class="img-responsive" />
            </a>
        </div>

    </div>
</div>
<div class="container kontenerMaterial" id="kontenerMaterialPortalPacjenta" style="padding:0">
    @* Treść ładowana AJAXem *@
    @Html.Partial("~/Views/Przychodnia/Terminarz/TerminarzPrzychodnia.cshtml")
</div>

@*@Html.Partial("_KartaRezerwacjiPrzychodnia")*@

@*-----------------------------------------------Okno z opcjami terminarza-----------------------------------------------------------*@
<div id="opcje-terminarza-okno" class="kontenerMaterial display-none">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

        <span>Godziny pracy przychodni:</span> <br />
        <label for="term-godz-pracy-od"> od </label> <input size="4" type="time" name="term-godz-pracy-od" value="" />
        <label for="term-godz-pracy-do"> do </label> <input size="4" type="time" name="term-godz-pracy-do" value="" />

        <div class="row">
            <label for="czas-trwania-wyzyty">Czas trwania wizyty (min): </label><input type="number" maxlength="2" max="60" min="1" name="czas-trwania-wyzyty" id="czas-trwania-wyzyty" />
        </div>
        <div class="row">
            <input type="checkbox" name="term-indywidulany-grafik" id="term-indywidulany-grafik" value="" /> Osobny grafik dla każdego pacownika
        </div>
        <button id="opcje-terminarza-zapisz-button" class="btn btn-primary" type="button">Zapisz</button>
        <button id="opcje-terminarza-anuluj-button" class="btn btn-danger" type="button">Anuluj</button>
        </form>
    </div>
</div>

<div id="okno-ustawiania-indywidualnego-grafika" class="kontenerMaterial display-none">
    <div class="row">
        Pracownik:
        <select class="form-control" onchange="wybranoLekarza()" id="wyborLekarzaPortalPacjenta">
            <option>Wybierz lekarza</option>
            @{
                foreach (var prac in ViewBag.Pracownicy)
                {
                    <option id="@prac.Id">@prac.Imie @prac.Nazwisko (@prac.Specjalizacja)</option>
                }
            }
        </select>

    </div>
    <div class="row">

    </div>
    <div class="row">

    </div>
</div>


<script>
    $(document).ready(function () {
       
        //wczytanie elementów do zmiennej daje lepszą wydajność, gdyż tylko raz wyszukujemy po id
        var loaderKontener = $("#loader-kontener");
        var dataRezerwacji = $('#wybor-daty-terminarz').val();
        var kontenerMaterialPortalPacjenta = $('#kontenerMaterialPortalPacjenta');
        var opcjeTerminarzaDiv = $('#opcje-terminarza-okno');
        var ustawianiaIndywidualnegoGrafikaDiv = $('#okno-ustawiania-indywidualnego-grafika');
        var czasTrwaniaWizyty = $("#czas-trwania-wyzyty");
        var termGodzPracyOd = $("#term-godz-pracy-od");
        var termGodzPracyDo = $("#term-godz-pracy-do");
    


        kontenerMaterialPortalPacjenta.css({
            "height": "100%",
            "visibility": "visible"
        });
        var oknoOpcjiTerminarza = {
            draggable: true,
            hide: { effect: "fade", duration: 250 },
            show: { effect: "fade", duration: 250 },
            resizable: false,
            autoOpen: false,
            width: "500px",
            title: "Opcje terminarza"
        };

        var oknoIndywidualnegoGrafika = {
            draggable: true,
            hide: { effect: "fade", duration: 250 },
            show: { effect: "fade", duration: 250 },
            resizable: false,
            autoOpen: false,
            title: "Zarządzanie godzinami pracy"
        };

        //--------------------------------- WYBÓR DATY -------------------------------------------------------------------------------------------------

        //wyświetla kalendarz przy wejściu w pole wyboru daty 
        var wyborDatyTerminarz = $("#wybor-daty-terminarz"); 
        wyborDatyTerminarz.datepicker({
            dateFormat: "yy-mm-dd",
            changeYear: true
        });
      

        wyborDatyTerminarz.change(function () {
            dataRezerwacji = $('#wybor-daty-terminarz').val();
            var wzor = /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/;
            var parts = dataRezerwacji.split('-');

            if (!wzor.test(dataRezerwacji)) {
                alert("Wybierz datę z kalendarza");
                kontenerMaterialPortalPacjenta.slideUp(500);
                return;
            }
            pobierzTerminarz(dataRezerwacji);
        });

        function pobierzTerminarz(dataRezerwacji) {
            $.ajax({
                url: '@Url.Action("pobierzTerminarz", "Terminarz")',
                data: {
                    wybranaData: dataRezerwacji
                },
                success: function (response) {
                    kontenerMaterialPortalPacjenta.slideUp(300, function myfunction() {
                        kontenerMaterialPortalPacjenta.html(response);
                    });
                    kontenerMaterialPortalPacjenta.slideDown(300);
                },
                error: function () {
                    alert("Błąd połączenia z serwerem!");

                    kontenerMaterialPortalPacjenta.slideUp(300, function myfunction() {
                        kontenerMaterialPortalPacjenta.html("");
                    });
                }
            });
        }

        //--------------------------------- END WYBÓR DATY -------------------------------------------------------------------------------------------------



        //--------------------------------- OPCJE TERMINARZA -------------------------------------------------------------------------------------------------

        $("#opcje-terminarza-button").click(function () {
            loaderKontener.switchClass("ukryty", "widoczny", 150, "swing");
            opcjeTerminarzaDiv.css("display", "block");
            $.ajax({
                url: '@Url.Action("pobierzOpcjeTerminarza", "Terminarz")',
                type: "POST",
                success: function (response) { //resposne to słownik sparsowany do jsona, klucz to nazwa opcji w bazie
                    loaderKontener.switchClass("widoczny", "ukryty", 150, "swing");

                    //ładowanie wartości opcji odczytanych z bazy do formularza opcji terminarza
                    //czasTrwaniaWizyty.val(response["term_czas_wiz"]);
                    

                    

                    //alert(t);
                    //termGodzPracyOd.val();
                    //termGodzPracyDo.val(response["term_godz_do"]);

                    opcjeTerminarzaDiv.dialog(oknoOpcjiTerminarza).dialog("open");
                },
                error: function () {
                    alert("Błąd połączenia z serwerem!");
                    loaderKontener.switchClass("widoczny", "ukryty", 150, "swing");
                }
            });
        });

        //Kontrola wartości wpisywanych przez użytkownika
        czasTrwaniaWizyty.keyup(function () {
            if ($(this).val().length > 1 && $(this).val().substring(0, 1) == '0') {//jeżeli poda zero na początku to wycina zero i zostawia pozostałe cyfry
                $(this).val($(this).val().substring(1));
            }
            else if ($(this).val() > 60) {// jeżeli wpisze wartość większą niż 60 to ustawi 60
                $(this).val('60');
            }
            else if ($(this).val() < 1) {// jeżeli wpisze wartość mniejszą niż 1 to ustawi 0
                $(this).val('0');
            }
        });
        czasTrwaniaWizyty.focusout(function () {
            if ($(this).val().trim() === '' || $(this).val() < 1) {//jeżeli nic nie wpisze, wpisze 0 lub wpisze coś innego niż cyfra to wstawi 1
                $(this).val('1');
            }
        });

        $("#term-indywidulany-grafik").change(function () {
            if ($(this).is(':checked')) {
                ustawianiaIndywidualnegoGrafikaDiv.dialog(oknoIndywidualnegoGrafika).dialog("open");
            }
        });

        $("#opcje-terminarza-zapisz-button").click(function () {
            loaderKontener.switchClass("ukryty", "widoczny", 150, "swing");
            $.ajax({
                url: '@Url.Action("zapiszOpcjeTerminarza", "Terminarz")',
                data: {
                    term_czas_wiz: czasTrwaniaWizyty.val()
                },
                success: function (response) {
                    loaderKontener.switchClass("widoczny", "ukryty", 150, "swing");
                    alert(response);
                    opcjeTerminarzaDiv.dialog("close");
                    pobierzTerminarz(dataRezerwacji);
                },
                error: function () {
                    loaderKontener.switchClass("widoczny", "ukryty", 150, "swing");
                    alert("Error");
                }
            });
        });

        $("#opcje-terminarza-anuluj-button").click(function () {
            opcjeTerminarzaDiv.dialog("close");
        });

        //--------------------------------- END OPCJE TERMINARZA -------------------------------------------------------------------------------------------------

    });
</script>
